# mcp-altegio

[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![MCP SDK](https://img.shields.io/badge/MCP_SDK-1.26-green)](https://github.com/modelcontextprotocol/typescript-sdk)
[![Bun](https://img.shields.io/badge/Bun-1.x-f9f1e1)](https://bun.sh)

MCP-сервер для [Altegio API](https://api.alteg.io/). Даёт AI-ассистентам (Claude, Cursor, VS Code Copilot) прямой доступ к управлению записями, клиентами, услугами, сотрудниками и расписанием.

Работает через протокол [Model Context Protocol](https://modelcontextprotocol.io/) — стандарт взаимодействия AI-моделей с внешними сервисами.

## Зачем

Если вы используете Altegio для управления бизнесом (салон, спа, клиника, барбершоп) и работаете с AI-ассистентом — этот MCP-сервер позволяет ассистенту напрямую:

- Смотреть записи на сегодня и фильтровать по мастеру
- Искать клиентов по имени или телефону
- Создавать и редактировать бронирования
- Проверять свободные слоты
- Получать финансовые данные

Без ручного копирования данных из Altegio — ассистент работает с API напямую.

## Инструменты

18 инструментов, разбитые по группам:

### Записи
| Инструмент | Описание |
|------------|----------|
| `get_records` | Записи за период с фильтрами по мастеру/клиенту |
| `get_records_by_client` | Все записи конкретного клиента |
| `get_records_by_visit` | Поиск записей по `api_id` (привязка к внешней системе) |
| `create_record` | Создать запись с полной настройкой параметров |
| `book_service` | Быстрое бронирование с привязкой к визиту |
| `update_record` | Изменить существующую запись |
| `delete_record` | Удалить запись |

### Клиенты
| Инструмент | Описание |
|------------|----------|
| `search_clients` | Поиск по имени, телефону или email (авто-определение) |
| `get_client` | Карточка клиента по ID |
| `create_client` | Создать нового клиента |
| `update_client` | Редактировать данные клиента |

### Услуги и сотрудники
| Инструмент | Описание |
|------------|----------|
| `get_services` | Каталог услуг (фильтр по мастеру/категории) |
| `get_service_categories` | Категории услуг |
| `get_staff` | Список сотрудников (по умолчанию без уволеных) |
| `get_staff_member` | Детали конкретного сотрудника |

### Расписание и финансы
| Инструмент | Описание |
|------------|----------|
| `get_available_times` | Свободные слоты на дату |
| `get_available_dates` | Рабочие дни мастера |
| `get_transactions` | Финансовые транзакции за период |

## Требования

- [Bun](https://bun.sh/) >= 1.0
- Партнёрский и пользовательский токены Altegio API

## Установка

```bash
git clone https://github.com/moro3k/mcp-altegio.git
cd mcp-altegio
bun install
```

## Настройка

```bash
cp .env.example .env
```

Заполните `.env`:

```env
ALTEGIO_TOKEN=ваш_партнёрский_токен
ALTEGIO_USER_TOKEN=ваш_пользовательский_токен
ALTEGIO_COMPANY_ID=ваш_id_компании
```

<details>
<summary><b>Где взять токены?</b></summary>

- **ALTEGIO_TOKEN** — партнёрский токен. Получается в кабинете разработчика Altegio после регистрации партнёрского аккаунта
- **ALTEGIO_USER_TOKEN** — пользовательский токен. Получается через POST-запрос авторизации к API (`/auth`), используя логин и пароль вашего аккаунта Altegio
- **ALTEGIO_COMPANY_ID** — ID компании. Виден в URL панели управления Altegio: `app.alteg.io/company/XXXXXX/...`

</details>

## Подключение

### Claude Desktop

Откройте файл конфигурации:

- **macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`
- **Windows**: `%APPDATA%\Claude\claude_desktop_config.json`

Добавьте:

```json
{
  "mcpServers": {
    "altegio": {
      "command": "bun",
      "args": ["run", "/полный/путь/к/mcp-altegio/src/index.ts"],
      "cwd": "/полный/путь/к/mcp-altegio"
    }
  }
}
```

Перезапустите Claude Desktop. В интерфейсе появится иконка MCP — значит сервер подключен.

### Claude Code

Добавьте в `.mcp.json` в корне вашего проекта:

```json
{
  "mcpServers": {
    "altegio": {
      "command": "bun",
      "args": ["run", "/полный/путь/к/mcp-altegio/src/index.ts"],
      "cwd": "/полный/путь/к/mcp-altegio"
    }
  }
}
```

### Cursor

Settings → MCP Servers → Add new server:

```json
{
  "altegio": {
    "command": "bun",
    "args": ["run", "/полный/путь/к/mcp-altegio/src/index.ts"],
    "cwd": "/полный/путь/к/mcp-altegio"
  }
}
```

### Переменные окружения

Bun автоматически подтягивает `.env` из директории `cwd`. Если не хотите использовать `.env` файл, передайте переменные напрямую:

```json
{
  "mcpServers": {
    "altegio": {
      "command": "bun",
      "args": ["run", "/полный/путь/к/mcp-altegio/src/index.ts"],
      "env": {
        "ALTEGIO_TOKEN": "...",
        "ALTEGIO_USER_TOKEN": "...",
        "ALTEGIO_COMPANY_ID": "..."
      }
    }
  }
}
```

## Примеры использования

### Посмотреть записи на сегодня

> «Покажи все записи на сегодня»

Ассистент вызовет `get_records` и покажет список бронирований с именами клиентов, услугами, временем и статусами.

### Найти клиента и его историю

> «Найди клиента по телефону +66812345678 и покажи его записи за последний месяц»

Ассистент сначала вызовет `search_clients`, затем `get_records_by_client` — и выдаст полную историю визитов.

### Забронировать услугу

> «Запиши Анну (+66999999999) на тайский массаж к мастеру Kai на завтра в 14:00»

Ассистент найдёт ID услуги через `get_services`, проверит доступность через `get_available_times`, и создаст запись через `create_record`.

### Проверить загрузку мастера

> «Покажи свободные слоты у Wanida на эту неделю»

Ассистент вызовет `get_available_dates`, затем `get_available_times` для каждого рабочего дня.

### Аналитика за период

> «Сколько записей было за прошлую неделю? Какие услуги самые популярные?»

Ассистент загрузит записи через `get_records` и проанализирует данные.

## Идеи для интеграций

- **Telegram-бот** — подключите MCP к боту для автоматического бронирования через чат
- **CRM-система** — связывайте записи Altegio с вашей внутренней системой через `api_id`
- **Дашборд** — собирайте аналитику по загрузке мастеров и популярности услуг
- **Автоматические отчёты** — генерируйте ежедневные/еженедельные сводки по записям и выручке
- **Синхронизация** — двустороняя связка между вашей системой и Altegio

## Особенности Altegio API

| Параметр | Описание |
|----------|----------|
| `api_id` | Только целое число (`number`). Строки игнорируются, записывается `0` |
| `save_if_busy` | Ставьте `true` при программном создании записей, иначе ошибка конфликта |
| `seance_length` | Длительность в **секундах**, не минутах! (3600 = 1 час) |
| `attendance` | `-1` отменён · `0` ожидается · `1` подтверждён · `2` пришёл |
| `fired` | `0` активный сотрудник · `1` уволенный |

## Структура проекта

```
mcp-altegio/
├── src/
│   ├── index.ts      # MCP-сервер, регистрация 18 инструментов
│   ├── api.ts        # HTTP-клиент (авторизация, подстановка company_id)
│   └── helpers.ts    # Вспомогательные функции (поиск, фильтры)
├── tests/
│   ├── helpers.test.ts  # Тесты хелперов (39 тестов)
│   ├── api.test.ts      # Тесты HTTP-клиента (37 тестов)
│   └── server.test.ts   # Интеграционные тесты MCP (55 тестов)
├── .env.example
├── package.json
├── tsconfig.json
└── LICENSE
```

## Тесты

131 тест с покрытием всех инструментов и бизнес-логики:

```bash
bun test
```

Тесты включают:
- **Unit-тесты** — автоопределение типа поиска (телефон/email/имя), фильтрация сотрудников и записей
- **Тесты API-клиента** — HTTP-методы, авторизация, query-параметры, обработка ошибок
- **Интеграционные тесты MCP** — регистрация инструментов, схемы, вызов через SDK клиент

## Стек

- **Runtime**: [Bun](https://bun.sh/) 1.x
- **SDK**: [@modelcontextprotocol/sdk](https://github.com/modelcontextprotocol/typescript-sdk) 1.26 — `registerTool` API, `zod/v4`
- **Тесты**: Bun Test (встроенный раннер, 131 тест)
- **Язык**: TypeScript
- **Transport**: stdio

## Участие в разработке

Буду рад пулл-реквестам! Форкайте, улучшайте, добавляйте новые инструменты.

Что можно добавить:
- Поддержка групповых событий (activities)
- Webhook-уведомления
- Кеширование запросов
- Работа с несколькими компаниями
- Складской учёт и товары

```bash
# Форкните репозиторий, затем:
git clone https://github.com/ваш-username/mcp-altegio.git
cd mcp-altegio
bun install
# Внесите изменения и откройте PR
```

## Лицензия

[MIT](LICENSE)
